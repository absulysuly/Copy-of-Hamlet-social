#!/bin/bash

# ???????????????????????????????????????????????????????????????
# IRAQ ELECTION API - AUTOMATIC DEPLOYMENT SCRIPT
# ???????????????????????????????????????????????????????????????

set -e

echo ""
echo "???????????????????????????????????????????????????????????????"
echo "??  DEPLOYING IRAQ ELECTION API TO RAILWAY  ??"
echo "???????????????????????????????????????????????????????????????"
echo ""

# Database URL from Railway
DB_URL="postgresql://postgres:ULbaXjTrdDBavxJnNScVSQkLmhqOonMc@crossover.proxy.rlwy.net:42786/railway"

echo "?? Step 1/6: Checking Railway CLI..."
if ! command -v railway &> /dev/null; then
    echo "Installing Railway CLI..."
    npm install -g @railway/cli
fi
echo "? Railway CLI ready"
echo ""

echo "?? Step 2/6: Logging in to Railway..."
echo "This will open your browser for authentication..."
railway login
echo "? Logged in"
echo ""

echo "?? Step 3/6: Linking to Railway project..."
echo "Select your project that has the Postgres database"
railway link
echo "? Project linked"
echo ""

echo "??  Step 4/6: Setting environment variables..."
railway variables set DATABASE_URL="$DB_URL"
railway variables set NODE_ENV=production
railway variables set ALLOWED_ORIGINS="*"
railway variables set LOG_LEVEL=info
echo "? Variables set"
echo ""

echo "?? Step 5/6: Deploying to Railway..."
echo "This will take 1-2 minutes..."
railway up
echo "? Deployed!"
echo ""

echo "? Waiting 30 seconds for deployment to be fully ready..."
sleep 30
echo ""

echo "???  Step 6/6: Setting up database..."
echo "Running migrations..."
railway run npx prisma migrate deploy
echo "? Database schema created"
echo ""

echo "?? Seeding database with 7,769 Iraqi candidates..."
echo "This will take about 30 seconds..."
railway run npm run db:seed:full
echo "? Database seeded!"
echo ""

echo "???????????????????????????????????????????????????????????????"
echo "??  DEPLOYMENT COMPLETE!  ??"
echo "???????????????????????????????????????????????????????????????"
echo ""

# Get the URL
echo "?? Getting your API URL..."
URL=$(railway status 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1)

if [ -z "$URL" ]; then
    echo "Your API is deployed!"
    echo "Run 'railway status' to get your URL"
else
    echo "Your API is live at: $URL"
    echo ""
    echo "?? Test it with these commands:"
    echo ""
    echo "# Health check"
    echo "curl $URL/health"
    echo ""
    echo "# Get candidates"
    echo "curl $URL/api/candidates?limit=5"
    echo ""
    echo "# Get statistics"
    echo "curl $URL/api/stats"
    echo ""
    echo "# Get governorates"
    echo "curl $URL/api/governorates"
fi

echo ""
echo "???????????????????????????????????????????????????????????????"
echo "?? Your database now contains:"
echo "   ? 7,769 Iraqi candidates"
echo "   ? 18 governorates"
echo "   ? 16 political parties"
echo "   ? Complete election data"
echo ""
echo "?? Next step: Connect your frontend!"
echo "   Set NEXT_PUBLIC_API_BASE_URL=$URL"
echo "???????????????????????????????????????????????????????????????"
echo ""
