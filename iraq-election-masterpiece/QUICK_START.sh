#!/bin/bash

# ???????????????????????????????????????????????????????????????
# IRAQ ELECTION API - QUICK START SCRIPT
# ???????????????????????????????????????????????????????????????

set -e

echo ""
echo "???????????????????????????????????????????????????????????????"
echo "????  IRAQ ELECTION API - QUICK START  ????"
echo "???????????????????????????????????????????????????????????????"
echo ""

# Check if .env exists
if [ ! -f .env ]; then
    echo "?? Creating .env file..."
    cp .env.example .env
    echo "??  Please edit .env and add your DATABASE_URL"
    echo ""
    echo "Example:"
    echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/iraq_election"
    echo ""
    read -p "Press Enter after you've configured .env..."
fi

# Install dependencies
echo "?? Installing dependencies..."
npm install

# Generate Prisma client
echo "?? Generating Prisma client..."
npm run db:generate

# Run migrations
echo "???  Running database migrations..."
npm run db:migrate

# Seed database
echo ""
echo "?? How many candidates do you want to seed?"
echo "1) 100 (for testing)"
echo "2) 7,769 (full Iraqi election dataset - recommended)"
echo "3) Custom amount"
read -p "Choice (1/2/3): " seed_choice

case $seed_choice in
    1)
        echo "?? Seeding 100 test candidates..."
        npm run db:seed:test
        ;;
    2)
        echo "?? Seeding 7,769 candidates (this may take 30 seconds)..."
        npm run db:seed:full
        ;;
    3)
        read -p "Enter number of candidates: " custom_count
        echo "?? Seeding $custom_count candidates..."
        SEED_COUNT=$custom_count npm run db:seed
        ;;
    *)
        echo "Invalid choice. Seeding default (7,769 candidates)..."
        npm run db:seed:full
        ;;
esac

# Success message
echo ""
echo "???????????????????????????????????????????????????????????????"
echo "?  SETUP COMPLETE!"
echo "???????????????????????????????????????????????????????????????"
echo ""
echo "?? To start the server, run:"
echo "   npm start    (production)"
echo "   npm run dev  (development)"
echo ""
echo "?? Server will start on: http://localhost:4001"
echo ""
echo "?? To test the API:"
echo "   npm test"
echo ""
echo "?? API Documentation:"
echo "   http://localhost:4001/api/docs"
echo ""
echo "?? Health Check:"
echo "   http://localhost:4001/health"
echo ""
echo "???????????????????????????????????????????????????????????????"
echo ""

# Ask if user wants to start server now
read -p "Do you want to start the server now? (y/n): " start_now

if [ "$start_now" = "y" ] || [ "$start_now" = "Y" ]; then
    echo ""
    echo "?? Starting server..."
    npm start
fi
